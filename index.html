<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ü§ñ RoboFit Controller</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 15px;
      overflow: hidden;
    }

    .container {
      max-width: 450px;
      width: 100%;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 5px;
      text-shadow: 0 0 30px rgba(0, 255, 200, 0.6);
    }

    .subtitle {
      font-size: 0.9em;
      color: #a0a0a0;
    }

    .status {
      background: rgba(255, 255, 255, 0.08);
      padding: 15px;
      border-radius: 20px;
      text-align: center;
      margin-bottom: 20px;
      backdrop-filter: blur(15px);
      border: 2px solid rgba(255, 255, 255, 0.15);
    }

    .status-text {
      font-size: 1.3em;
      font-weight: 700;
      color: #00ffcc;
      margin-bottom: 10px;
    }

    .status-indicators {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 15px;
      background: rgba(0, 0, 0, 0.3);
      font-size: 0.85em;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }

    .status-indicator.online .status-dot {
      background: #4caf50;
      box-shadow: 0 0 10px #4caf50;
    }

    .status-indicator.offline .status-dot {
      background: #f44336;
      box-shadow: 0 0 10px #f44336;
      animation: blink 1s ease-in-out infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .status-indicator.checking .status-dot {
      background: #ff9800;
      box-shadow: 0 0 10px #ff9800;
    }

    .last-seen {
      font-size: 0.75em;
      color: #888;
      margin-top: 8px;
    }

    .control-panel {
      background: rgba(255, 255, 255, 0.06);
      padding: 25px;
      border-radius: 30px;
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 255, 255, 0.1);
    }

    .control-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .btn {
      width: 100%;
      aspect-ratio: 1;
      border: none;
      border-radius: 20px;
      background: linear-gradient(145deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 2em;
      cursor: pointer;
      transition: all 0.1s;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      touch-action: none;
    }

    .btn:active {
      transform: scale(0.93);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.6);
    }

    .btn.active {
      transform: scale(0.93);
      background: linear-gradient(145deg, #764ba2 0%, #667eea 100%);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.8), inset 0 0 20px rgba(255,255,255,0.2);
    }

    .btn-stop {
      background: linear-gradient(145deg, #ff6b6b 0%, #ee5a6f 100%);
      font-size: 2.3em;
    }

    .btn-backward {
      background: linear-gradient(145deg, #f093fb 0%, #f5576c 100%);
    }

    .extra-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }

    .btn-small {
      padding: 15px;
      border: none;
      border-radius: 15px;
      background: linear-gradient(145deg, #11998e 0%, #38ef7d 100%);
      color: white;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.1s;
      touch-action: none;
    }

    .btn-small:active, .btn-small.active {
      transform: scale(0.95);
    }

    .keyboard-hints {
      margin-top: 15px;
      text-align: center;
      font-size: 0.8em;
      color: #888;
      padding: 10px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
    }

    @media (max-width: 480px) {
      h1 { font-size: 2em; }
      .btn { font-size: 1.7em; }
      .control-panel { padding: 20px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ü§ñ RoboFit</h1>
      <div class="subtitle">MULTI-BUTTON CONTROLLER</div>
    </div>
    
    <div class="status">
      <div class="status-text" id="statusText">READY</div>
      <div class="status-indicators">
        <div class="status-indicator checking" id="controllerStatus">
          <div class="status-dot"></div>
          <span>Controller</span>
        </div>
        <div class="status-indicator checking" id="robotStatus">
          <div class="status-dot"></div>
          <span>Robot</span>
        </div>
      </div>
      <div class="last-seen" id="lastSeen">Checking robot status...</div>
    </div>

    <div class="control-panel">
      <div class="control-grid">
        <!-- Row 1 -->
        <button class="btn" data-cmd="forward_left">‚Üñ</button>
        <button class="btn" data-cmd="forward">‚Üë</button>
        <button class="btn" data-cmd="forward_right">‚Üó</button>

        <!-- Row 2 -->
        <button class="btn" data-cmd="left">‚Üê</button>
        <button class="btn btn-stop" data-cmd="stop">‚ñ†</button>
        <button class="btn" data-cmd="right">‚Üí</button>

        <!-- Row 3 -->
        <button class="btn btn-backward" data-cmd="backward">‚Üì</button>
        <button class="btn btn-backward" data-cmd="backward">‚Üì</button>
        <button class="btn btn-backward" data-cmd="backward">‚Üì</button>
      </div>

      <div class="extra-controls">
        <button class="btn-small" data-cmd="pivot_left">‚ü≤ Pivot L</button>
        <button class="btn-small" data-cmd="pivot_right">‚ü≥ Pivot R</button>
      </div>

      <div class="keyboard-hints">
        üí° Press multiple buttons for combined movement<br>
        Arrow Keys / WASD supported
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set, onValue, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // Firebase configuration
    const firebaseConfig = {
      databaseURL: "https://robofit-691fc-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    let currentCommand = "";
    let activeButtons = new Set();
    let pressedKeys = new Set();
    let robotOnline = false;
    let lastSeenTime = null;

    const statusText = document.getElementById('statusText');
    const controllerStatus = document.getElementById('controllerStatus');
    const robotStatus = document.getElementById('robotStatus');
    const lastSeenDiv = document.getElementById('lastSeen');
    const allButtons = document.querySelectorAll('[data-cmd]');

    // Haptic feedback
    function vibrate() {
      if ('vibrate' in navigator) navigator.vibrate(10);
    }

    // Update status displays
    function updateCommandStatus(text) {
      statusText.textContent = text.toUpperCase();
    }

    function updateControllerStatus(online) {
      controllerStatus.className = 'status-indicator ' + (online ? 'online' : 'offline');
    }

    function updateRobotStatus(online, timestamp = null) {
      robotOnline = online;
      robotStatus.className = 'status-indicator ' + (online ? 'online' : 'offline');
      
      if (online) {
        lastSeenDiv.textContent = 'üü¢ Robot is connected and ready';
      } else if (timestamp) {
        const date = new Date(parseFloat(timestamp) * 1000);
        const now = new Date();
        const diffSeconds = Math.floor((now - date) / 1000);
        
        let timeAgo;
        if (diffSeconds < 60) {
          timeAgo = `${diffSeconds} seconds ago`;
        } else if (diffSeconds < 3600) {
          timeAgo = `${Math.floor(diffSeconds / 60)} minutes ago`;
        } else {
          timeAgo = date.toLocaleTimeString();
        }
        
        lastSeenDiv.textContent = `üî¥ Last seen: ${timeAgo}`;
      } else {
        lastSeenDiv.textContent = 'üî¥ Robot not connected';
      }
    }

    // Monitor robot status from Firebase
    const statusRef = ref(database, 'status');
    onValue(statusRef, (snapshot) => {
      const data = snapshot.val();
      
      if (data && data.online === true) {
        updateRobotStatus(true);
        console.log('‚úÖ Robot is ONLINE');
      } else {
        updateRobotStatus(false, data?.lastSeen);
        console.log('‚ùå Robot is OFFLINE');
      }
    });

    // Check controller connection
    setInterval(async () => {
      try {
        await get(ref(database, '.info/connected'));
        updateControllerStatus(true);
      } catch {
        updateControllerStatus(false);
      }
    }, 3000);

    // Calculate combined command from multiple button presses
    function getCombinedCommand() {
      const buttons = Array.from(activeButtons);
      
      if (buttons.length === 0) return 'stop';
      if (buttons.length === 1) return buttons[0];
      
      // Multi-button logic
      const hasForward = buttons.includes('forward');
      const hasBackward = buttons.includes('backward');
      const hasLeft = buttons.includes('left');
      const hasRight = buttons.includes('right');
      
      // Forward + Turn
      if (hasForward && hasLeft) return 'forward_left';
      if (hasForward && hasRight) return 'forward_right';
      
      // Backward + Turn (not implemented in Python, defaults to backward)
      if (hasBackward && hasLeft) return 'backward';
      if (hasBackward && hasRight) return 'backward';
      
      // Pivot commands take priority
      if (buttons.includes('pivot_left')) return 'pivot_left';
      if (buttons.includes('pivot_right')) return 'pivot_right';
      
      // Default to first button
      return buttons[0];
    }

    // Send command to Firebase
    async function sendCommand(cmd) {
      if (cmd === currentCommand) return;
      
      currentCommand = cmd;
      
      try {
        await set(ref(database, 'commands/move'), cmd);
        updateCommandStatus(cmd || 'STOP');
        updateControllerStatus(true);
        console.log('üì§ Command sent:', cmd);
      } catch (error) {
        console.error('‚ùå Failed to send command:', error);
        updateControllerStatus(false);
      }
    }

    // Button handlers
    function handleButtonPress(cmd) {
      if (cmd === 'stop') {
        activeButtons.clear();
        allButtons.forEach(btn => btn.classList.remove('active'));
        sendCommand('stop');
      } else {
        activeButtons.add(cmd);
        const combined = getCombinedCommand();
        sendCommand(combined);
      }
    }

    function handleButtonRelease(cmd) {
      activeButtons.delete(cmd);
      const combined = getCombinedCommand();
      sendCommand(combined);
    }

    // Attach events to buttons
    allButtons.forEach(button => {
      const cmd = button.dataset.cmd;
      
      if (cmd === 'stop') {
        button.addEventListener('click', () => {
          vibrate();
          handleButtonPress('stop');
        });
        return;
      }
      
      // Touch events
      button.addEventListener('touchstart', (e) => {
        e.preventDefault();
        vibrate();
        button.classList.add('active');
        handleButtonPress(cmd);
      });
      
      button.addEventListener('touchend', (e) => {
        e.preventDefault();
        button.classList.remove('active');
        handleButtonRelease(cmd);
      });
      
      button.addEventListener('touchcancel', (e) => {
        e.preventDefault();
        button.classList.remove('active');
        handleButtonRelease(cmd);
      });
      
      // Mouse events (for desktop)
      button.addEventListener('mousedown', (e) => {
        e.preventDefault();
        vibrate();
        button.classList.add('active');
        handleButtonPress(cmd);
      });
      
      button.addEventListener('mouseup', (e) => {
        e.preventDefault();
        button.classList.remove('active');
        handleButtonRelease(cmd);
      });
      
      button.addEventListener('mouseleave', () => {
        if (button.classList.contains('active')) {
          button.classList.remove('active');
          handleButtonRelease(cmd);
        }
      });
    });

    // Keyboard controls
    const keyMap = {
      'ArrowUp': 'forward', 'w': 'forward', 'W': 'forward',
      'ArrowDown': 'backward', 's': 'backward', 'S': 'backward',
      'ArrowLeft': 'left', 'a': 'left', 'A': 'left',
      'ArrowRight': 'right', 'd': 'right', 'D': 'right',
      ' ': 'stop', 'x': 'stop', 'X': 'stop'
    };

    document.addEventListener('keydown', (e) => {
      const cmd = keyMap[e.key];
      if (cmd && !pressedKeys.has(e.key)) {
        e.preventDefault();
        pressedKeys.add(e.key);
        
        const button = document.querySelector(`[data-cmd="${cmd}"]`);
        if (button && cmd !== 'stop') {
          button.classList.add('active');
          handleButtonPress(cmd);
        } else if (cmd === 'stop') {
          handleButtonPress('stop');
        }
      }
    });

    document.addEventListener('keyup', (e) => {
      const cmd = keyMap[e.key];
      if (cmd && pressedKeys.has(e.key)) {
        e.preventDefault();
        pressedKeys.delete(e.key);
        
        const button = document.querySelector(`[data-cmd="${cmd}"]`);
        if (button && cmd !== 'stop') {
          button.classList.remove('active');
          handleButtonRelease(cmd);
        }
      }
    });

    // Prevent scrolling on touch devices
    document.addEventListener('touchmove', (e) => {
      if (e.target.closest('.control-panel')) e.preventDefault();
    }, { passive: false });

    // Page visibility - stop robot when tab hidden
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        activeButtons.clear();
        pressedKeys.clear();
        allButtons.forEach(btn => btn.classList.remove('active'));
        sendCommand('stop');
      }
    });

    // Window blur - stop robot when losing focus
    window.addEventListener('blur', () => {
      activeButtons.clear();
      pressedKeys.clear();
      allButtons.forEach(btn => btn.classList.remove('active'));
      sendCommand('stop');
    });

    // Initialize
    console.log("üéÆ RoboFit Multi-Button Controller Ready!");
    sendCommand('stop');
    updateCommandStatus('READY');
    updateControllerStatus(true);
  </script>
</body>
</html>